{% extends "base.html" %}
{% block content %}

<div class="container-fluid">
  <h1 class="page-header">Staffing Simulator</h1>
  <form name="game" method="post" action="/{{generation}}">
    {% csrf-field %}
    <div class="row">
      <div class="col-sm-3">
        <div class="available_staff_table">
          <div class="staffing_plans_project_header">
            <h3>Available staff</h3>
          </div>

          {% safe %} {{people-table}} {% endsafe %}

        </div>
        <div class="counter"></div>
        <h3>Staffing Actions</h3>
        <div class="action_log_table">
          <ul id="action_log">
          </ul>
        </div>
      </div>
      <div class="col-sm-9">
        {% include "project-table.html" %}
        <!-- {{old-projects|count}} -->
        <h3>Past projects</h3>
        {% for project in old-projects %}
          {% include "old-project-table.html" %}
        {% endfor %}
      </div>  
    </div>  
  </form>
</div>

{% endblock %}

{% block page-scripts %}

<script type="text/javascript">

$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip(); 
});

String.prototype.capitalise = function() {
    return this.replace(/(?:^|\s)\S/g, function(a) { return a.toUpperCase(); });
};

var selectedProjectRole = null;

function logAction(actionText) {
  var actionLog = document.getElementById("action_log");
  var action = document.createElement("li");
  action.appendChild(document.createTextNode(actionText));
  actionLog.insertBefore(action, actionLog.childNodes[0]);
}

function gradeRoleTupleToString(gradeRoleTuple) {
  var tupleBits = gradeRoleTuple.split("_");
  return (tupleBits[0] + " " + tupleBits[1]).capitalise();
}

function assignStaffToSelectedRole(selectedStaff) {
  var currentCount = $(selectedStaff).text();
  if (currentCount > 0) {
    $(selectedStaff).text(currentCount - 1);
    var assignedStaffTitle = gradeRoleTupleToString($(selectedStaff).attr('id'));
    logAction("Assigned " + assignedStaffTitle + " - " + (currentCount - 1) + " remaining");
    $(selectedProjectRole).addClass("project_role_assigned_row");
    $(selectedProjectRole).find('td.open_role').each (function() {
      $(this).addClass("assigned_role");
    });                    
    $(selectedProjectRole).find('td.staffing_plans_role_title_cell a').each (function() {
      $(this).attr('data-original-title', "Assigned: " + assignedStaffTitle).tooltip('show');
    });      
  }
}

function selectProjectRole(selectedRole) {
  $(PROJECT_ROLE_ROW).removeClass("project_role_selected_row");
  $(selectedRole).addClass("project_role_selected_row");
  logAction("Selected role for '" + gradeRoleTupleToString($(selectedRole).attr('id')) + "'");
  selectedProjectRole = $(selectedRole);  
}

const STAFF_COUNT_CELL = ".staffing_table > tbody > tr > td.staffing_plans_role_cell_count";
const PROJECT_ROLE_ROW = ".staffing_plans_project > .project_table > tbody > tr";

$(PROJECT_ROLE_ROW).click(function() {
  selectProjectRole(this);
});

$(STAFF_COUNT_CELL).click(function() {
  if (selectedProjectRole != null) {
    assignStaffToSelectedRole(this);
  }
});

function handleTimerExpiry() {
  clock.reset();
  selectedProjectRole = null;
  $(PROJECT_ROLE_ROW).removeClass("project_role_selected_row");
  $(PROJECT_ROLE_ROW).removeClass("project_role_assigned_row");
  // $('.staffing_plans_project').addClass('disabled')
  // document.game.submit();
}

var clock = $('.counter').FlipClock(20, {
    clockFace: 'Counter'
  });

  setTimeout(function() {
    var interval = setInterval(function() {
      if(clock.getTime().time <= 0) {
        handleTimerExpiry();
      }     
      clock.decrement();
    }, 1000);
  });
</script>

{% endblock %}
